# Multi-Factor Authentication (MFA)

{% hint style="info" %}
Strengthen your account security with TOTP-based two-step verification.
{% endhint %}

## Overview

Multi-Factor Authentication (MFA) enhances account security by requiring an additional authentication step beyond the password. bkend supports TOTP (Time-based One-Time Password) and is compatible with apps like Google Authenticator and Authy.

***

## MFA Setup Flow

```mermaid
sequenceDiagram
    participant User as User
    participant API as bkend API
    participant App as Authenticator App

    User->>API: 1. POST /auth/mfa/enable (password)
    API-->>User: secret + QR code
    User->>App: Scan QR code
    App-->>User: Generate 6-digit code
    User->>API: 2. POST /auth/mfa/confirm (code)
    API-->>User: MFA activation complete
```

***

## Enable MFA

### Step 1: Prepare MFA Activation

```bash
curl -X POST https://api-client.bkend.ai/v1/auth/mfa/enable \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {accessToken}" \
  -H "X-Project-Id: {project_id}" \
  -H "X-Environment: dev" \
  -d '{
    "password": "MyP@ssw0rd!"
  }'
```

| Parameter | Type | Required | Description |
|-----------|------|:--------:|-------------|
| `password` | `string` | Yes | Current password (identity verification) |

**Response:**

```json
{
  "secret": "JBSWY3DPEHPK3PXP",
  "qrCode": "data:image/png;base64,...",
  "issuer": "Bkend",
  "otpauth": "otpauth://totp/Bkend:user@example.com?secret=JBSWY3DPEHPK3PXP&issuer=Bkend"
}
```

| Field | Description |
|-------|-------------|
| `secret` | Base32-encoded secret (for manual entry) |
| `qrCode` | QR code image (Base64) |
| `issuer` | Service name |
| `otpauth` | OTPAuth URI (for opening directly in the app) |

### Step 2: Confirm MFA Activation

Enter the 6-digit code generated by your Authenticator app.

```bash
curl -X POST https://api-client.bkend.ai/v1/auth/mfa/confirm \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {accessToken}" \
  -H "X-Project-Id: {project_id}" \
  -H "X-Environment: dev" \
  -d '{
    "code": "123456"
  }'
```

| Parameter | Type | Required | Description |
|-----------|------|:--------:|-------------|
| `code` | `string` | Yes | 6-digit code from the Authenticator app |

{% hint style="success" %}
Once MFA is enabled, you must enter a 6-digit code along with your password for subsequent sign-ins.
{% endhint %}

***

## Disable MFA

### POST /v1/auth/mfa/disable

```bash
curl -X POST https://api-client.bkend.ai/v1/auth/mfa/disable \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {accessToken}" \
  -H "X-Project-Id: {project_id}" \
  -H "X-Environment: dev" \
  -d '{
    "password": "MyP@ssw0rd!",
    "code": "123456"
  }'
```

| Parameter | Type | Required | Description |
|-----------|------|:--------:|-------------|
| `password` | `string` | Yes | Current password |
| `code` | `string` | - | 6-digit code from the Authenticator app |

{% hint style="danger" %}
**Warning** -- Disabling MFA weakens your account security.
{% endhint %}

***

## MFA Sign-in

When signing in with MFA enabled, include `mfaCode` in the request.

```bash
curl -X POST https://api-client.bkend.ai/v1/auth/email/signin \
  -H "Content-Type: application/json" \
  -H "X-Project-Id: {project_id}" \
  -H "X-Environment: dev" \
  -d '{
    "method": "password",
    "email": "user@example.com",
    "password": "MyP@ssw0rd!",
    "mfaCode": "123456"
  }'
```

***

## Error Responses

| Error Code | HTTP | Description |
|------------|:----:|-------------|
| `auth/invalid-credentials` | 401 | Incorrect password |
| `auth/invalid-mfa-code` | 401 | Incorrect MFA code |
| `auth/mfa-already-enabled` | 400 | MFA is already enabled |
| `auth/mfa-not-enabled` | 400 | MFA is not enabled on this account |

***

## Next Steps

- [Email Sign-in](03-email-signin.md) -- MFA sign-in
- [Session Management](10-session-management.md) -- Check active sessions
- [Security Best Practices](../security/07-best-practices.md) -- Security recommendations

## Reference Standards

- [RFC 6238 -- TOTP](https://datatracker.ietf.org/doc/html/rfc6238)
